<div class="checkout-container">
  <div class="checkout-header">
    <h1>Checkout</h1>
    <div class="step-indicator">
      <div class="step" [class.active]="currentStep >= 1" [class.completed]="currentStep > 1">
        <span class="step-number">1</span>
        <span class="step-label">Cart Review</span>
      </div>
      <div class="step" [class.active]="currentStep >= 2" [class.completed]="currentStep > 2">
        <span class="step-number">2</span>
        <span class="step-label">Shipping</span>
      </div>
      <div class="step" [class.active]="currentStep >= 3" [class.completed]="currentStep > 3">
        <span class="step-number">3</span>
        <span class="step-label">Payment</span>
      </div>
      <div class="step" [class.active]="currentStep >= 4">
        <span class="step-number">4</span>
        <span class="step-label">Confirmation</span>
      </div>
    </div>
  </div>
  <div class="checkout-content">

    <!-- Step 1: Cart Review -->
    <div class="checkout-step" *ngIf="currentStep === 1">
      <h2>Review Your Order</h2>
      <div class="cart-items" *ngIf="cartItems.length > 0">
        <div class="cart-item" *ngFor="let item of cartItems">
          <img [src]="getImageUrl(item.product.images[0])" [alt]="item.product.name" class="item-image">
          <div class="item-details">
            <h3>{{ item.product.name }}</h3>
            <p class="item-brand">{{ item.product.brand }}</p>
            <div class="item-variants" *ngIf="item.size || item.color">
              <span *ngIf="item.size">Size: {{ item.size }}</span>
              <span *ngIf="item.color">Color: {{ item.color }}</span>
            </div>
            <div class="item-price">
              <span class="current-price">₹{{ item.product.price | number:'1.0-0' }}</span>
              <span class="original-price" *ngIf="item.product.originalPrice">
                    ₹{{ item.product.originalPrice | number:'1.0-0' }}
                  </span>
            </div>
          </div>
          <div class="item-quantity">
            <span>Qty: {{ item.quantity }}</span>
            <span class="item-total">₹{{ (item.product.price * item.quantity) | number:'1.0-0' }}</span>
          </div>
        </div>
      </div>
      <div class="empty-cart" *ngIf="cartItems.length === 0">
        <i class="fas fa-shopping-cart"></i>
        <h3>Your cart is empty</h3>
        <p>Add some items to your cart to continue</p>
        <button class="btn btn-primary" (click)="goToShopping()">Continue Shopping</button>
      </div>
    </div>

    <!-- Step 2: Shipping Information -->
    <div class="checkout-step" *ngIf="currentStep === 2">
      <h2>Shipping Information</h2>
      <form [formGroup]="shippingForm" class="shipping-form">
        <div class="form-row">
          <div class="form-group">
            <label for="fullName">Full Name *</label>
            <input type="text" id="fullName" formControlName="fullName" class="form-control">
            <div class="error-message" *ngIf="shippingForm.get('fullName')?.invalid && shippingForm.get('fullName')?.touched">
              Full name is required
            </div>
          </div>
          <div class="form-group">
            <label for="phone">Phone Number *</label>
            <input type="tel" id="phone" formControlName="phone" class="form-control">
            <div class="error-message" *ngIf="shippingForm.get('phone')?.invalid && shippingForm.get('phone')?.touched">
              Valid phone number is required
            </div>
          </div>
        </div>
        <div class="form-group">
          <label for="addressLine1">Address Line 1 *</label>
          <input type="text" id="addressLine1" formControlName="addressLine1" class="form-control">
          <div class="error-message" *ngIf="shippingForm.get('addressLine1')?.invalid && shippingForm.get('addressLine1')?.touched">
            Address is required
          </div>
        </div>
        <div class="form-group">
          <label for="addressLine2">Address Line 2</label>
          <input type="text" id="addressLine2" formControlName="addressLine2" class="form-control">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="city">City *</label>
            <input type="text" id="city" formControlName="city" class="form-control">
            <div class="error-message" *ngIf="shippingForm.get('city')?.invalid && shippingForm.get('city')?.touched">
              City is required
            </div>
          </div>
          <div class="form-group">
            <label for="state">State *</label>
            <select id="state" formControlName="state" class="form-control">
              <option value="">Select State</option>
              <option value="Maharashtra">Maharashtra</option>
              <option value="Delhi">Delhi</option>
              <option value="Karnataka">Karnataka</option>
              <option value="Tamil Nadu">Tamil Nadu</option>
              <option value="Gujarat">Gujarat</option>
              <option value="Rajasthan">Rajasthan</option>
              <option value="West Bengal">West Bengal</option>
              <option value="Uttar Pradesh">Uttar Pradesh</option>
            </select>
            <div class="error-message" *ngIf="shippingForm.get('state')?.invalid && shippingForm.get('state')?.touched">
              State is required
            </div>
          </div>
          <div class="form-group">
            <label for="pincode">Pincode *</label>
            <input type="text" id="pincode" formControlName="pincode" class="form-control" maxlength="6">
            <div class="error-message" *ngIf="shippingForm.get('pincode')?.invalid && shippingForm.get('pincode')?.touched">
              Valid 6-digit pincode is required
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- Step 3: Payment Method -->
    <div class="checkout-step" *ngIf="currentStep === 3">
      <h2>Payment Method</h2>
      <div class="payment-methods">
        <div class="payment-option" *ngFor="let method of paymentMethods" [class.selected]="selectedPaymentMethod === method.id" (click)="selectPaymentMethod(method.id)">
          <i [class]="method.icon"></i>
          <div class="method-details">
            <h3>{{ method.name }}</h3>
            <p>{{ method.description }}</p>
          </div>
          <div class="method-radio">
            <input type="radio" [value]="method.id" [(ngModel)]="selectedPaymentMethod">
          </div>
        </div>
      </div>
    </div>

    <!-- Step 4: Order Confirmation -->
    <div class="checkout-step" *ngIf="currentStep === 4">
      <div class="order-confirmation" *ngIf="!orderPlaced">
        <h2>Order Confirmation</h2>
        <div class="confirmation-details">
          <div class="shipping-summary">
            <h3>Shipping Address</h3>
            <div class="address-display">
              <p><strong>{{ shippingForm.get('fullName')?.value }}</strong></p>
              <p>{{ shippingForm.get('phone')?.value }}</p>
              <p>{{ shippingForm.get('addressLine1')?.value }}</p>
              <p *ngIf="shippingForm.get('addressLine2')?.value">{{ shippingForm.get('addressLine2')?.value }}</p>
              <p>{{ shippingForm.get('city')?.value }}, {{ shippingForm.get('state')?.value }} {{ shippingForm.get('pincode')?.value }}</p>
            </div>
          </div>
          <div class="payment-summary">
            <h3>Payment Method</h3>
            <p>{{ getPaymentMethodName(selectedPaymentMethod) }}</p>
          </div>
        </div>
      </div>
      <div class="order-success" *ngIf="orderPlaced">
        <div class="success-icon">
          <i class="fas fa-check-circle"></i>
        </div>
        <h2>Order Placed Successfully!</h2>
        <p>Your order #{{ orderNumber }} has been placed successfully.</p>
        <div class="order-actions">
          <button class="btn btn-primary" (click)="viewOrder()">View Order</button>
          <button class="btn btn-secondary" (click)="continueShopping()">Continue Shopping</button>
        </div>
      </div>
    </div>

    <!-- Order Summary Sidebar -->
    <div class="order-summary">
      <h3>Order Summary</h3>

      <!-- Cart Total Amount Display (Prominent) -->
      <div class="cart-total-highlight" *ngIf="cartSummary">
        <div class="total-amount-display">
          <i class="fas fa-shopping-cart"></i>
          <div class="amount-details">
            <span class="amount-label">Cart Total Amount</span>
            <span class="amount-value">₹{{ cartSummary.total | number:'1.0-0' }}</span>
          </div>
        </div>
      </div>
      <div class="summary-line">
        <span>Subtotal ({{ cartSummary?.itemCount }} items)</span>
        <span>₹{{ cartSummary?.subtotal | number:'1.0-0' }}</span>
      </div>
      <div class="summary-line" *ngIf="cartSummary && cartSummary.discount > 0">
        <span>Discount</span>
        <span class="discount">-₹{{ cartSummary.discount | number:'1.0-0' }}</span>
      </div>
      <div class="summary-line">
        <span>Tax (18% GST)</span>
        <span>₹{{ getTaxAmount() | number:'1.0-0' }}</span>
      </div>
      <div class="summary-line">
        <span>Shipping</span>
        <span>FREE</span>
      </div>
      <div class="summary-line total">
        <span><strong>Final Total</strong></span>
        <span><strong>₹{{ cartSummary?.total | number:'1.0-0' }}</strong></span>
      </div>
      <div class="checkout-actions">
        <button class="btn btn-secondary" *ngIf="currentStep > 1 && currentStep < 4" (click)="previousStep()" [disabled]="processing">
          Previous
        </button>
        <button class="btn btn-primary" *ngIf="currentStep < 4" (click)="nextStep()" [disabled]="!canProceed() || processing">
          <span *ngIf="!processing">{{ currentStep === 3 ? 'Place Order' : 'Continue' }}</span>
          <span *ngIf="processing">
                <i class="fas fa-spinner fa-spin"></i> Processing...
              </span>
        </button>
      </div>
    </div>
  </div>
</div>